/**\n * Storage Utility for Cloudflare R2 / AWS S3\n * Handles file uploads, presigned URLs, and file management\n */\n\nimport {\n  S3Client,\n  PutObjectCommand,\n  DeleteObjectCommand,\n  GetObjectCommand,\n} from '@aws-sdk/client-s3'\nimport { getSignedUrl } from '@aws-sdk/s3-request-presigner'\nimport { v4 as uuidv4 } from 'uuid'\n\n// Initialize S3 client for Cloudflare R2 or AWS S3\nconst s3Client = new S3Client({\n  region: 'auto', // R2 uses 'auto', S3 uses actual region\n  endpoint: process.env.R2_ACCOUNT_ID\n    ? `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`\n    : undefined, // Use default AWS endpoint if R2 not configured\n  credentials: {\n    accessKeyId: process.env.R2_ACCESS_KEY_ID || process.env.AWS_ACCESS_KEY_ID || '',\n    secretAccessKey:\n      process.env.R2_SECRET_ACCESS_KEY || process.env.AWS_SECRET_ACCESS_KEY || '',\n  },\n})\n\nconst BUCKET_NAME =\n  process.env.R2_BUCKET_NAME || process.env.AWS_S3_BUCKET || 'modelsmagix-uploads'\n\nconst PUBLIC_URL =\n  process.env.R2_PUBLIC_URL || `https://${BUCKET_NAME}.s3.amazonaws.com`\n\nexport interface UploadResult {\n  key: string\n  url: string\n  bucket: string\n}\n\n/**\n * Generate a unique file key with path\n */\nexport function generateFileKey(userId: string, filename: string): string {\n  const ext = filename.split('.').pop()\n  const uniqueId = uuidv4()\n  return `users/${userId}/${Date.now()}-${uniqueId}.${ext}`\n}\n\n/**\n * Upload a file to R2/S3\n */\nexport async function uploadFile(\n  buffer: Buffer,\n  key: string,\n  contentType: string\n): Promise<UploadResult> {\n  const command = new PutObjectCommand({\n    Bucket: BUCKET_NAME,\n    Key: key,\n    Body: buffer,\n    ContentType: contentType,\n  })\n\n  await s3Client.send(command)\n\n  return {\n    key,\n    url: `${PUBLIC_URL}/${key}`,\n    bucket: BUCKET_NAME,\n  }\n}\n\n/**\n * Delete a file from R2/S3\n */\nexport async function deleteFile(key: string): Promise<void> {\n  const command = new DeleteObjectCommand({\n    Bucket: BUCKET_NAME,\n    Key: key,\n  })\n\n  await s3Client.send(command)\n}\n\n/**\n * Generate a presigned URL for direct client upload\n * (Useful for large files)\n */\nexport async function getPresignedUploadUrl(\n  key: string,\n  contentType: string,\n  expiresIn: number = 3600 // 1 hour\n): Promise<string> {\n  const command = new PutObjectCommand({\n    Bucket: BUCKET_NAME,\n    Key: key,\n    ContentType: contentType,\n  })\n\n  return await getSignedUrl(s3Client, command, { expiresIn })\n}\n\n/**\n * Generate a presigned URL for downloading a private file\n */\nexport async function getPresignedDownloadUrl(\n  key: string,\n  expiresIn: number = 3600 // 1 hour\n): Promise<string> {\n  const command = new GetObjectCommand({\n    Bucket: BUCKET_NAME,\n    Key: key,\n  })\n\n  return await getSignedUrl(s3Client, command, { expiresIn })\n}\n
